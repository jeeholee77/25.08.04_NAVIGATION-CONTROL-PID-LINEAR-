#!/usr/bin/env python3

import rclpy
from rclpy.node import Node
from std_msgs.msg import Int32, Int32MultiArray
from sensor_msgs.msg import NavSatFix
import sys
import threading
import time

class ControlPanelNode(Node):
    def __init__(self):
        super().__init__('control_panel_node')

        # ìƒíƒœ ë³€ìˆ˜ ì´ˆê¸°í™”
        self.current_position = ("-", "-")
        self.goal_latlon = ("-", "-")
        self.status = [-1, -1]
        self.heading = -1
        self.safe_heading_list = []
        self.final_heading = -1
        self.motor_cmd = []

        # ë§ˆì§€ë§‰ ìˆ˜ì‹  ì‹œê°„
        self.last_received = {
            'fix': 0,
            'goal': 0,
            'status': 0,
            'heading': 0,
            'safe': 0,
            'final': 0,
            'motor': 0
        }

        # êµ¬ë…ì ë“±ë¡
        self.create_subscription(NavSatFix, '/fix', self.fix_callback, 10)
        self.create_subscription(NavSatFix, '/waypoint/goal', self.goal_callback, 10)
        self.create_subscription(Int32MultiArray, '/waypoint/status', self.status_callback, 10)
        self.create_subscription(Int32, '/waypoint/heading', self.heading_callback, 10)
        self.create_subscription(Int32MultiArray, '/safe_heading_list', self.safe_heading_callback, 10)
        self.create_subscription(Int32, '/final_heading', self.final_heading_callback, 10)
        self.create_subscription(Int32MultiArray, '/motor/pwm_cmd', self.motor_cmd_callback, 10)

        # ì¶œë ¥ ì“°ë ˆë“œ ì‹œì‘
        self.print_thread = threading.Thread(target=self.display_loop, daemon=True)
        self.print_thread.start()

    # ì½œë°±ë“¤ + ìˆ˜ì‹  ì‹œê°„ ê¸°ë¡
    def fix_callback(self, msg):
        self.current_position = (f"{msg.latitude:.6f}", f"{msg.longitude:.6f}")
        self.last_received['fix'] = time.monotonic()

    def goal_callback(self, msg):
        self.goal_latlon = (f"{msg.latitude:.6f}", f"{msg.longitude:.6f}")
        self.last_received['goal'] = time.monotonic()

    def status_callback(self, msg):
        self.status = msg.data
        self.last_received['status'] = time.monotonic()

    def heading_callback(self, msg):
        self.heading = msg.data
        self.last_received['heading'] = time.monotonic()

    def safe_heading_callback(self, msg):
        self.safe_heading_list = msg.data
        self.last_received['safe'] = time.monotonic()

    def final_heading_callback(self, msg):
        self.final_heading = msg.data
        self.last_received['final'] = time.monotonic()

    def motor_cmd_callback(self, msg):
        self.motor_cmd = msg.data
        self.last_received['motor'] = time.monotonic()

    # ì‹¤ì‹œê°„ í™”ë©´ ì¶œë ¥
    def display_loop(self):
        while rclpy.ok():
            now = time.monotonic()
            print("\033[2J\033[H", end="")  # í™”ë©´ clear + ì»¤ì„œ top

            # í˜„ì¬ ìœ„ì¹˜
            print("ğŸ“¡ Current Position  : ", end="")
            if now - self.last_received['fix'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.current_position[0]}, {self.current_position[1]}")

            print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")

            # ëª©í‘œ ìœ„ì¹˜
            print("ğŸ“ Current Goal      : ", end="")
            if now - self.last_received['goal'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.goal_latlon[0]}, {self.goal_latlon[1]}")

            # ëª©í‘œ ìƒíƒœ
            print("ğŸ¯ Goal Status       : ", end="")
            if now - self.last_received['status'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                goal_number = self.status[0]
                status_code = self.status[1]
                if goal_number == 2 and status_code == 1:
                    print("ë¯¸ì…˜ ì»´í”Œë¦¿ âœ…")
                elif goal_number > 0:
                    print(f"{goal_number}ë²ˆ ì£¼í–‰ì¤‘")
                else:
                    print("ì •ë³´ ì—†ìŒ")
            print()  # ì¤„ ë„ì›€

            # ìƒëŒ€ í—¤ë”©
            print("ğŸ§­ Waypoint Heading  : ", end="")
            if now - self.last_received['heading'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.heading}Â°")

            # ì•ˆì „ í—¤ë”©
            print("ğŸ›¡ï¸ Safe Headings     : ", end="")
            if now - self.last_received['safe'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.safe_heading_list}")
            print()  # ì¤„ ë„ì›€

            # ì‹¤ì œ ì£¼í–‰ ë°©í–¥
            print("âœ… Final Heading     : ", end="")
            if now - self.last_received['final'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.final_heading}Â°")

            # ëª¨í„° ëª…ë ¹
            print("âš™ï¸ Motor PWM Command : ", end="")
            if now - self.last_received['motor'] > 5:
                print("âš ï¸ ë¯¸ìˆ˜ì‹ ")
            else:
                print(f"{self.motor_cmd}")

            print("â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
            sys.stdout.flush()
            time.sleep(0.5)

def main(args=None):
    rclpy.init(args=args)
    node = ControlPanelNode()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    finally:
        node.destroy_node()
        rclpy.shutdown()

if __name__ == '__main__':
    main()
